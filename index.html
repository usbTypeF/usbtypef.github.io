<!DOCTYPE html>
<html>
	<head>
		<title>Audio Tests</title>
	</head>
	
	<body>
		<label for="selectTest" id="selectTestlabel" style="display: block;">Select a test:</label>
		<select id="selectTest" style="display: block;">
			<option value="testcheck">Select a test</option>
			<option value="bitdepth">Bit Depth</option>
			<option value="bitrate">Bitrate</option>
			<option value="codec">Codec</option>
			<option value="inversion">Inversion</option>
			<option value="pitch">Pitch</option>
			<option value="frequency">Frequency</option>
			<option value="samplerate">Sample Rate</option>
			<option value="volume">Volume</option>
		</select>
			<br>
		<label for="selectAudio" id="selectAudiolabel" style="display: block;">Select an audio file:</label>
		<select id="selectAudio" style="display: block;">
		</select>
			<br>
		<button id="selectButton" style="display: block;">Select Audio</button>
		<p id="selectedAudioMessage" style="display: block;"></p>
		<button id="playA" style="display: none;"></button>
		<button id="playX" style="display: none;">Play X</button>
		<button id="playB" style="display: none;"></button>
			<br>
			<br>
		<button id="pause" style="display: none;">Pause</button>
		<button id="reset" onclick="resetTime();" style="display: none;">Reset</button>
			<br>
			<br>
		<input type="range" id="slider" min="0" max="60" value="0" step="0.01" style="display: none;" disabled>
			<br>
		<select id="guess" style="display: none;">
			<option>A is X</option>
			<option>B is X</option>
		</select>
		<button id="confirm" onclick="test()" style="display: none;">Next Trial</button>
			<br>
		<p id="trialCount" style="display: none;"></p>
		<button id="startTestButton" onclick="startTest()" style="display: none;">Start Test</button>
		<button id="endTestButton" onclick="endTest()" style="display: none;">End Test</button>
		<p id="warning" style="display: none;">You need a minimum of 16 trials to get a score</p>
		<p id="score" style="display: none;"></p>
		<br>
		<br>
		<br>
		<br>
		<div id="counter">
   			 <?php include("counter.php"); ?>
		</div>
	</body>

    <script>
		function startTest() {
			document.getElementById("trialCount").innerHTML = "Trials: 0";
			document.getElementById("startTestButton").style.display = "none";
			document.getElementById("endTestButton").style.display = "block";
			document.getElementById("playA").style.display = "inline";
			document.getElementById("playX").style.display = "inline";
			document.getElementById("playB").style.display = "inline";
			document.getElementById("selectAudio").style.display = "none";
			document.getElementById("selectButton").style.display = "none";
			document.getElementById("selectTest").style.display = "none";
			document.getElementById("selectTestlabel").style.display = "none";
			document.getElementById("selectAudiolabel").style.display = "none";
			document.getElementById("selectedAudioMessage").style.display = "block";
			document.getElementById("slider").style.display = "block";
			document.getElementById("reset").style.display = "inline";
			document.getElementById("pause").style.display = "inline";
			document.getElementById("warning").style.display = "block";
			document.getElementById("trialCount").style.display = "block";	
			document.getElementById("guess").style.display = "inline";	
			document.getElementById("confirm").style.display = "inline";	
			document.getElementById("score").style.display = "none";
		}

		function endTest() {
			document.getElementById("selectedAudioMessage").style.display = "none";
			document.getElementById("endTestButton").style.display = "none";
			document.getElementById("selectAudio").style.display = "block";
			document.getElementById("playA").style.display = "none";
			document.getElementById("playX").style.display = "none";
			document.getElementById("playB").style.display = "none";
			document.getElementById("selectButton").style.display = "block";
			document.getElementById("selectTest").style.display = "block";
			document.getElementById("selectTestlabel").style.display = "block";
			document.getElementById("selectAudiolabel").style.display = "block";
			document.getElementById("reset").style.display = "none";
			document.getElementById("slider").style.display = "none";
			document.getElementById("pause").style.display = "none";
			document.getElementById("warning").style.display = "none";	
			document.getElementById("trialCount").style.display = "none";	
			document.getElementById("guess").style.display = "none";	
			document.getElementById("confirm").style.display = "none";	
			document.getElementById("score").style.display = "block";	
			pauseAudio();
			currentTime = 0;
			count = 0;
			correct = 0;
		}

		function resetTime() {
			pauseAudio();
			currentTime = 0;
			slider.value = currentTime;
		}

		var audioFiles = [
			["Test check", "silent.wav", "sine.wav"],
			["Bit Depth", "bitdepth lossless.wav", "8bit.wav", "16bit.wav", "24bit.wav"],
			["Bitrate", "bitrate lossless.wav", "64k.wav", "96k.wav", "128k.wav", "192k.wav", "256k.wav"],
			["Codec", "codec lossless.wav", "opus.wav", "aac.wav", "mp3.wav", "vorbis.wav"],
			["Inversion", "correct polarity.wav", "inverted polarity.wav"],
			["Pitch", "pitch lossless.wav", "+1 cent.wav", "-1 cent.wav", "+2 cent.wav", "-2 cent.wav", "+5 cent.wav", "-5 cent.wav"],
			["Frequency", "frequency lossless.wav", "20khz.wav", "19khz.wav", "18khz.wav", "17khz.wav", "16khz.wav"],
			["Sample Rate", "samplerate lossless.wav", "44100.wav", "48000.wav", "96000.wav"],
			["Volume", "volume lossless.wav", "+0.1db.wav", "-0.1db.wav", "+0.2db.wav", "-0.2db.wav", "+0.5db.wav", "-0.5db.wav"]
		];

		var audioX, audioA, audioB;
		var count = 0;
		var correct = 0;
		var file = 0;
		var question = 0;
		var guess = 0;
		var currentTime = 0;
		var isPlaying = false;
		var activeAudio;
		const playAButton = document.getElementById("playA");
		const playXButton = document.getElementById("playX");
		const playBButton = document.getElementById("playB");
		const pauseButton = document.getElementById("pause");
		const slider = document.getElementById("slider");

		const playAudio = (audio) => {
			audioA.pause();
			audioX.pause();
			audioB.pause();
			activeAudio = audio;
			activeAudio.currentTime = currentTime;
			activeAudio.play();
			isPlaying = true;
		};

		const pauseAudio = () => {
			audioA.pause();
			audioX.pause();
			audioB.pause();
			isPlaying = false;
			slider.value = currentTime;
		};
		
		setInterval(() => {
			if (isPlaying) {
				currentTime += 0.01;
				slider.value = currentTime;
			}
			if (currentTime >= 60) {
				pauseAudio();
				currentTime = 0;
			}
		},	10);

		function populateAudioSelect() {
			var testSelect = document.getElementById("selectTest");
			var audioSelect = document.getElementById("selectAudio");
			var selectedIndex = testSelect.selectedIndex;
			var selectedRow = audioFiles[selectedIndex];
			audioSelect.innerHTML = "";

			for (var i = 1; i < selectedRow.length; i++) {
				var option = document.createElement("option");
				option.text = selectedRow[i];
				audioSelect.add(option);
			}
		}

		function selectOption() {
			var audioSelect = document.getElementById("selectAudio");
			var selectedOption = audioSelect.options[audioSelect.selectedIndex].value;
		}

		function randomize() {
			var audioSelect = document.getElementById("selectAudio");
			var selectedAudioIndex = audioSelect.options[audioSelect.selectedIndex].index;
			var selectedAudio = audioSelect.options[selectedAudioIndex].value;
			
			if (Math.random() < 0.5) {
				audioX = new Audio(audioFiles[document.getElementById("selectTest").selectedIndex][1]);
				file = 0;
			} else {
				audioX = new Audio(selectedAudio);
				file = 1;
			}

			if(count > 15){
				if(correct/count > 0.7) {
					document.getElementById("score").innerHTML = "There is a " + (10 * Math.sqrt((correct/count - 0.5)*200)).toFixed(2) + " percent chance you can tell between " + selectedAudio + " and " + audioFiles[document.getElementById("selectTest").selectedIndex][1];
				}	
			} else if (count > 15) {
				document.getElementById("score").innerHTML = "You cannot reliably tell between " + selectedAudio + " and " + audioFiles[document.getElementById("selectTest").selectedIndex][1];
			} else {
				document.getElementById("score").innerHTML = "You did not complete enough trials to get a score";
			}
		}

		function selectAudio() {
			document.getElementById("startTestButton").style.display = "block";
			document.getElementById("selectedAudioMessage").style.display = "block";
			var audioSelect = document.getElementById("selectAudio");
			var selectedAudioIndex = audioSelect.options[audioSelect.selectedIndex].index;
			var selectedAudio = audioSelect.options[selectedAudioIndex].value;
			var row = audioFiles[selectedAudioIndex];
			var selectedAudioFile = row[2 + audioSelect.options[audioSelect.selectedIndex].index];
		
			if(Math.random() < 0.5) {
				audioA = new Audio(selectedAudio);
				audioB = new Audio(audioFiles[document.getElementById("selectTest").selectedIndex][1]);
				question = 1;
			} else {
				audioA = new Audio(audioFiles[document.getElementById("selectTest").selectedIndex][1]);
				audioB = new Audio(selectedAudio);
				question = 0;
			}
			randomize();
			var message = "You have selected \"" + audioFiles[document.getElementById("selectTest").selectedIndex][0] + "." + selectedAudio + "\" to compare against \"" + audioFiles[document.getElementById("selectTest").selectedIndex][0] + "." + audioFiles[document.getElementById("selectTest").selectedIndex][1] + "\"";
			document.getElementById("selectedAudioMessage").innerHTML = message;
			document.getElementById("playA").innerHTML = "Play A";
			document.getElementById("playB").innerHTML = "Play B";
		}

		function test() {
			guess = document.getElementById("guess").selectedIndex;
			if((file + question) % 2 == guess) {
				correct++;
				count++;
			} else {
				count++;
			}
			document.getElementById("trialCount").innerHTML = "Trials: " + count;
			pauseAudio();
			randomize();
			resetTime();
		}
	
		var testSelect = document.getElementById("selectTest");
		testSelect.addEventListener("change", populateAudioSelect);

		var audioSelect = document.getElementById("selectAudio");
		audioSelect.addEventListener("change", selectOption);

		var selectButton = document.getElementById("selectButton");
		selectButton.addEventListener("click", selectAudio);

		playAButton.addEventListener("click", () => {
			playAudio(audioA);
		});

		playXButton.addEventListener("click", () => {
			playAudio(audioX);
		});

		playBButton.addEventListener("click", () => {
			playAudio(audioB);
		});	

		pauseButton.addEventListener("click", () => {
			pauseAudio();
		});

		
	</script>
</html>
