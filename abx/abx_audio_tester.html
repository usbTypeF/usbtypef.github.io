<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABX Audio Testing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #242424;
            border-radius: 4px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .completion-badge {
            font-size: 18px;
            font-weight: 600;
            color: #4CAF50;
        }

        .test-grid-container {
            background: #242424;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .test-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .test-card:hover {
            border-color: #4CAF50;
        }

        .test-card.selected {
            border-color: #4CAF50;
            background: #2f3f2f;
        }

        .test-card.passed {
            border-color: #4CAF50;
        }

        .test-card.failed {
            border-color: #666;
        }

        .test-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .test-status {
            font-size: 12px;
            color: #999;
        }

        .test-status.passed {
            color: #4CAF50;
        }

        .test-status.failed {
            color: #999;
        }

        .status-icon {
            font-size: 18px;
            margin-top: 5px;
        }

        .test-interface {
            background: #242424;
            border-radius: 4px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .test-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .trial-counter {
            font-size: 16px;
            color: #999;
        }

        .audio-section {
            margin-bottom: 40px;
        }

        .section-label {
            font-size: 14px;
            color: #999;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .play-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
            min-width: 100px;
        }

        .play-button:hover {
            background: #45a049;
        }

        .play-button:disabled {
            background: #333;
            cursor: not-allowed;
        }

        .play-button.playing {
            background: #ff9800;
        }

        .time-display {
            font-size: 14px;
            color: #999;
            font-family: monospace;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.1s;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-button {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 2px solid #333;
            padding: 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .option-button:hover {
            border-color: #4CAF50;
        }

        .option-button.selected {
            background: #2f3f2f;
            border-color: #4CAF50;
        }

        .submit-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 30px;
            width: 100%;
            transition: background 0.2s;
        }

        .submit-button:hover {
            background: #45a049;
        }

        .submit-button:disabled {
            background: #333;
            cursor: not-allowed;
        }

        .results {
            text-align: center;
            padding: 30px;
        }

        .results-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .results-score {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .results-score.passed {
            color: #4CAF50;
        }

        .results-score.failed {
            color: #f44336;
        }

        .results-message {
            font-size: 18px;
            color: #999;
            margin-bottom: 30px;
        }

        .restart-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .restart-button:hover {
            background: #45a049;
        }

        .error-message {
            background: #3f2f2f;
            border: 2px solid #f44336;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #e0e0e0;
        }

        .loading-progress {
            margin-top: 10px;
            font-size: 14px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Audio Testing Platform</h1>
        <div class="completion-badge" id="completionBadge">0% Complete</div>
    </div>

    <div class="test-grid-container">
        <div class="test-grid" id="testGrid">
            <div class="loading">Loading tests...</div>
        </div>
    </div>

    <div class="test-interface" id="testInterface">
        <div class="test-info">
            <div class="test-title" id="testTitle">Select a test to begin</div>
            <div class="trial-counter" id="trialCounter"></div>
        </div>

        <div id="testContent"></div>
    </div>

    <script>
        const TEST_CONFIGS = {
            2: { name: 'ABX', trials: 19 },
            3: { name: 'ABCX', trials: 15 },
            4: { name: 'ABCDX', trials: 11 },
            5: { name: 'ABCDEX', trials: 7 },
            6: { name: 'ABCDEFX', trials: 5 }
        };

        const PASS_THRESHOLD = 0.8;
        const TRACK_DURATION = 60;

        let availableTests = [];
        let currentTest = null;
        let currentTrial = 0;
        let correctAnswers = 0;
        let trackAssignments = {};
        let currentSelection = null;
        let audioElements = {};
        let currentlyPlaying = null;
        let syncTime = 0;

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        function getTestStatus(testName) {
            return getCookie(`test_${testName}`) || 'untested';
        }

        function setTestStatus(testName, status) {
            setCookie(`test_${testName}`, status);
        }

        async function loadCSV(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`Failed to load ${filename}`);
                const text = await response.text();
                const lines = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#'));
                return lines;
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return null;
            }
        }

        async function discoverTests() {
            // Fetch the manifest.json file that lists all CSV files
            try {
                const response = await fetch('manifest.json');
                if (!response.ok) {
                    throw new Error('manifest.json not found');
                }
                const data = await response.json();
                const testFiles = data.tests || [];
                
                const tests = [];
                for (const filename of testFiles) {
                    const tracks = await loadCSV(filename);
                    if (tracks && tracks.length >= 2 && tracks.length <= 6) {
                        const config = TEST_CONFIGS[tracks.length];
                        tests.push({
                            name: filename,
                            tracks: tracks,
                            format: config.name,
                            trials: config.trials,
                            status: getTestStatus(filename)
                        });
                    }
                }
                return tests;
            } catch (error) {
                console.error('Error loading manifest:', error);
                document.getElementById('testGrid').innerHTML = 
                    '<div class="error-message">Please create a manifest.json file with a list of your CSV test files.<br><br>Example:<br>{"tests": ["test.csv", "losslesstest.csv"]}</div>';
                return [];
            }
        }

        async function initTests() {
            availableTests = await discoverTests();

            if (availableTests.length === 0) {
                document.getElementById('testGrid').innerHTML = 
                    '<div class="error-message">No test CSV files found. Please create a CSV file with 2-6 audio files listed.</div>';
                return;
            }

            renderTestGrid();
            updateCompletionBadge();
        }

        function renderTestGrid() {
            const grid = document.getElementById('testGrid');
            grid.innerHTML = '';

            availableTests.forEach(test => {
                const card = document.createElement('div');
                card.className = `test-card ${test.status}`;
                card.onclick = () => startTest(test);

                let statusIcon = '';
                let statusText = 'Untested';
                
                if (test.status === 'passed') {
                    statusIcon = '✓';
                    statusText = 'Passed';
                } else if (test.status === 'failed') {
                    statusIcon = '✗';
                    statusText = 'Failed';
                }

                card.innerHTML = `
                    <div class="test-name">${test.name}</div>
                    <div class="test-status ${test.status}">${statusText}</div>
                    ${statusIcon ? `<div class="status-icon">${statusIcon}</div>` : ''}
                `;

                grid.appendChild(card);
            });
        }

        function updateCompletionBadge() {
            const passed = availableTests.filter(t => t.status === 'passed').length;
            const total = availableTests.length;
            const percentage = total > 0 ? Math.round((passed / total) * 100) : 0;
            document.getElementById('completionBadge').textContent = `${percentage}% Complete`;
        }

        function startTest(test) {
            showLoadingOverlay('Preparing test...', 0, test.tracks.length);
            
            currentTest = test;
            currentTrial = 0;
            correctAnswers = 0;
            
            const shuffled = [...test.tracks].sort(() => Math.random() - 0.5);
            trackAssignments = {};
            shuffled.forEach((track, i) => {
                trackAssignments[String.fromCharCode(65 + i)] = track;
            });

            preloadAllAudio();
        }

        async function preloadAllAudio() {
            const tracks = Object.values(trackAssignments);
            const loadedAudio = {};
            let loadedCount = 0;

            const loadPromises = tracks.map((track, index) => {
                return new Promise((resolve, reject) => {
                    const audio = new Audio(track);
                    
                    audio.addEventListener('canplaythrough', () => {
                        loadedAudio[track] = audio;
                        loadedCount++;
                        updateLoadingProgress(loadedCount, tracks.length);
                        resolve();
                    }, { once: true });

                    audio.addEventListener('error', (e) => {
                        console.error(`Error preloading ${track}:`, e);
                        reject(new Error(`Failed to load ${track}`));
                    }, { once: true });

                    audio.preload = 'auto';
                    audio.load();
                });
            });

            try {
                await Promise.all(loadPromises);
                // Store preloaded audio for quick access
                window.preloadedAudio = loadedAudio;
                hideLoadingOverlay();
                startTrial();
            } catch (error) {
                hideLoadingOverlay();
                alert(`Failed to load audio files: ${error.message}\nMake sure all audio files exist in the same directory.`);
                restartTests();
            }
        }

        function showLoadingOverlay(text, current, total) {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'loading-overlay';
                document.body.appendChild(overlay);
            }

            overlay.innerHTML = `
                <div class="spinner"></div>
                <div class="loading-text">${text}</div>
                <div class="loading-progress">Loading audio: ${current} / ${total}</div>
            `;
            overlay.style.display = 'flex';
        }

        function updateLoadingProgress(current, total) {
            const progressEl = document.querySelector('.loading-progress');
            if (progressEl) {
                progressEl.textContent = `Loading audio: ${current} / ${total}`;
            }
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function startTrial() {
            currentSelection = null;
            syncTime = 0;
            audioElements = {};
            if (currentlyPlaying) {
                currentlyPlaying.pause();
                currentlyPlaying = null;
            }

            const letters = Object.keys(trackAssignments);
            const xLetter = letters[Math.floor(Math.random() * letters.length)];
            const xTrack = trackAssignments[xLetter];

            document.getElementById('testTitle').textContent = `${currentTest.format} Test`;
            document.getElementById('trialCounter').textContent = 
                `Trial ${currentTrial + 1} of ${currentTest.trials}`;

            const content = document.getElementById('testContent');
            content.innerHTML = `
                <div class="audio-section">
                    <div class="section-label">Reference (X)</div>
                    <div class="audio-controls">
                        <button class="play-button" id="btnX" onclick="playAudio('X')">Play X</button>
                    </div>
                </div>

                <div class="audio-section">
                    <div class="section-label">Options</div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        ${letters.map(letter => `
                            <button class="play-button" id="btn${letter}" onclick="playAudio('${letter}')">${letter}</button>
                        `).join('')}
                    </div>
                </div>

                <div class="audio-section">
                    <div class="audio-controls">
                        <button class="play-button" id="btnPause" onclick="pauseAudio()">Pause</button>
                        <button class="play-button" id="btnReset" onclick="resetAudio()">Reset</button>
                        <span class="time-display" id="timeDisplay">0:00 / 1:00</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
                </div>

                <div class="section-label">Which option matches X?</div>
                <div class="options-grid">
                    ${letters.map(letter => `
                        <button class="option-button" onclick="selectOption('${letter}')" id="option${letter}">
                            ${letter}
                        </button>
                    `).join('')}
                </div>

                <button class="submit-button" onclick="submitAnswer()" id="submitBtn" disabled>Submit Answer</button>
            `;

            // Preload audio
            audioElements['X'] = createAudio(xTrack);
            letters.forEach(letter => {
                audioElements[letter] = createAudio(trackAssignments[letter]);
            });

            // Store correct answer
            audioElements['X'].correctLetter = xLetter;
        }

        function createAudio(filename) {
            // Use preloaded audio if available
            if (window.preloadedAudio && window.preloadedAudio[filename]) {
                const audio = window.preloadedAudio[filename].cloneNode();
                audio.addEventListener('timeupdate', updateProgress);
                audio.addEventListener('ended', handleAudioEnd);
                return audio;
            }

            // Fallback to creating new audio element
            const audio = new Audio(filename);
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', handleAudioEnd);
            audio.addEventListener('error', (e) => {
                console.error(`Error loading ${filename}:`, e);
                alert(`Failed to load audio file: ${filename}\nMake sure the file exists in the same directory.`);
            });
            return audio;
        }

        function playAudio(id) {
            // Stop currently playing audio
            if (currentlyPlaying) {
                const oldId = currentlyPlaying.dataset.id;
                syncTime = currentlyPlaying.currentTime;
                currentlyPlaying.pause();
                document.getElementById(`btn${oldId}`).classList.remove('playing');
            }

            const audio = audioElements[id];
            audio.currentTime = syncTime;
            audio.dataset.id = id;
            audio.play();
            currentlyPlaying = audio;
            document.getElementById(`btn${id}`).classList.add('playing');
        }

        function updateProgress() {
            if (!currentlyPlaying) return;

            const id = currentlyPlaying.dataset.id;
            const currentTime = currentlyPlaying.currentTime;
            const duration = TRACK_DURATION;

            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);
            const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const timeEl = document.getElementById('timeDisplay');
            if (timeEl) {
                timeEl.textContent = `${timeStr} / 1:00`;
            }
            
            const progressEl = document.getElementById('progressBar');
            if (progressEl) {
                progressEl.style.width = `${(currentTime / duration) * 100}%`;
            }

            syncTime = currentTime;
        }

        function pauseAudio() {
            if (currentlyPlaying) {
                const id = currentlyPlaying.dataset.id;
                syncTime = currentlyPlaying.currentTime;
                currentlyPlaying.pause();
                document.getElementById(`btn${id}`).classList.remove('playing');
                currentlyPlaying = null;
            }
        }

        function resetAudio() {
            if (currentlyPlaying) {
                const id = currentlyPlaying.dataset.id;
                currentlyPlaying.pause();
                document.getElementById(`btn${id}`).classList.remove('playing');
                currentlyPlaying = null;
            }
            
            syncTime = 0;
            
            const timeEl = document.getElementById('timeDisplay');
            if (timeEl) {
                timeEl.textContent = '0:00 / 1:00';
            }
            
            const progressEl = document.getElementById('progressBar');
            if (progressEl) {
                progressEl.style.width = '0%';
            }
        }

        function handleAudioEnd() {
            if (currentlyPlaying) {
                const id = currentlyPlaying.dataset.id;
                document.getElementById(`btn${id}`).classList.remove('playing');
                currentlyPlaying = null;
                syncTime = 0;
            }
        }

        function selectOption(letter) {
            currentSelection = letter;
            
            const letters = Object.keys(trackAssignments);
            letters.forEach(l => {
                const btn = document.getElementById(`option${l}`);
                btn.classList.toggle('selected', l === letter);
            });
            
            document.getElementById('submitBtn').disabled = false;
        }

        function submitAnswer() {
            if (!currentSelection) return;

            if (currentlyPlaying) {
                currentlyPlaying.pause();
                const id = currentlyPlaying.dataset.id;
                document.getElementById(`btn${id}`).classList.remove('playing');
                currentlyPlaying = null;
            }

            const isCorrect = currentSelection === audioElements['X'].correctLetter;
            if (isCorrect) correctAnswers++;

            currentTrial++;

            if (currentTrial < currentTest.trials) {
                startTrial();
            } else {
                showResults();
            }
        }

        function showResults() {
            const requiredCorrect = Math.floor(currentTest.trials * PASS_THRESHOLD);
            const passed = correctAnswers >= requiredCorrect;

            setTestStatus(currentTest.name, passed ? 'passed' : 'failed');
            
            const content = document.getElementById('testContent');
            content.innerHTML = `
                <div class="results">
                    <div class="results-title">${passed ? 'Test Passed!' : 'Test Failed'}</div>
                    <div class="results-score ${passed ? 'passed' : 'failed'}">
                        ${correctAnswers} / ${currentTest.trials}
                    </div>
                    <div class="results-message">
                        ${Math.round((correctAnswers / currentTest.trials) * 100)}% correct
                        ${passed ? `(${requiredCorrect}+ required to pass)` : `(Need ${requiredCorrect}+ to pass)`}
                    </div>
                    <button class="restart-button" onclick="restartTests()">Back to Tests</button>
                </div>
            `;

            initTests();
        }

        function restartTests() {
            if (currentlyPlaying) {
                currentlyPlaying.pause();
                currentlyPlaying = null;
            }
            currentTest = null;
            document.getElementById('testTitle').textContent = 'Select a test to begin';
            document.getElementById('trialCounter').textContent = '';
            document.getElementById('testContent').innerHTML = '';
        }

        // Initialize on load
        initTests();
    </script>
</body>
</html>